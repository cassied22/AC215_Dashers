networks:
    recipe-rag-network:
        external: true
services:
    recipe-rag-cli:
        image: recipe-rag-cli
        container_name: recipe-rag-cli
        volumes:
            - ../../src/secrets:/secrets
            - ../../src/datapipeline:/app
            - ../datapipeline:/app/tests
        environment:
            GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS
            GCP_PROJECT: $GCP_PROJECT
            GCS_BUCKET_NAME: $GCS_BUCKET_NAME
            PATH: "/home/app/.local/bin:${PATH}"
        networks:
            - recipe-rag-network
        entrypoint: ["/bin/bash", "-c"]
        command: ["pipenv install pytest-cov && pipenv run pytest --cov=./ --cov-config=.coveragerc"]
        depends_on:
            - chromadb

    chromadb:
        image: chromadb/chroma:latest
        container_name: recipe-rag-chromadb
        ports:
            - 8000:8000
        volumes:
            - ../../src/datapipeline/docker-volumes/chromadb:/chroma/chroma
        environment:
            - IS_PERSISTENT=TRUE
            - ANONYMIZED_TELEMETRY=FALSE
            - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"] # This is not recommended for production environments.
        networks:
            - recipe-rag-network
    
    food-detection:
        image: food-detection
        container_name: food-detection
        volumes:
          - ../../src/food-detection:/app
          - ../food-detection:/app/tests
        entrypoint: ["/bin/bash", "-c"]
        command: ["pipenv install pytest-cov && pipenv run pytest --cov=./ --cov-config=.coveragerc"]
        networks:
          - recipe-rag-network